# Netfilter

The linux firewall is called `netfilter` which is a packet filtering mechanism. `iptables` is just one of the ways to manage `netfilter`.
- iptables = usually on most servers
- ufw = Uncomplicated firewall (Ubuntu default)
- firewalld = RHEL and offsprings

## Chains
Netfilter uses the concept of chains. A packet goes through a series of chains from the moment it reaches an interface or is generated by a local process until the moment it gets to a local process or it goes out an interface.
The default chains used by netfilter are: 
- PREROUTING: rules in this chain applies to packets as they just arrive on the network interface
  - RAW --> connection tracking --> MANGLE --> D-NAT --> routing decision
- INPUT: rules in this chain apply after the routing decision and just before they are given to a local process
  - MANGLE --> FILTER --> SECURITY --> S-NAT
- FORWARD: rules in this chain apply only to packets that are routed through the current host and which are not destined to a local process
  - MANGLE --> FILTER --> SECURITY
- OUTPUT: rules in this chain apply after they've been produced by a process
  - routing decision --> RAW --> connection tracking --> MANGLE --> D-NAT --> routing decision --> FILTER --> SECURITY
- POSTROUTING: rules in this chain apply only to packets that just leave the network interface
  - MANGLE --> S-NAT

[Routing chains](https://drive.google.com/file/d/1cf22SG73SNpKz8Ex9ukNmQx1kxuEM0Tw/view)

A packet destined to a local process will go through PREROUTING and INPUT chains.
A packed generated by a local process will go through POSTROUTING and OUTPUT chains
A packed recieved on an interface but destined to another host will go through PREROUTING, FORWARD and POSTROUTING chains.

You can add your own chains but by default only the default chais will be used. If you want a packet to pass through your custom chain you will need to add a rule in one of the default chains in order to "JUMP" to your custom chain.
To add/remove your own chains, use:

```
iptables -N CHAIN_TO_CREATE
iptables -X CHAIN_TO_DELETE
```

## Tables
There is a list of tables that are used in each chain. These tables hold rules that apply in the chain. iptables comes with 5 *tables* of rules:
- RAW: Allows you to work with packets before they are tracked. Packets marked with "NOTRACK" will skip the connection trakcing table.
- connection tracking: Packet manipulation is based on the state of the connection:
  - NEW: when a new packet that is not associated with an existing connection enters the chain
  - ESTABLISHED - a connection is established when a response is seen in the opposite direction. This works for UDP, ICMP and TCP(only if the response is SYN/ACK)
  - RELATED: packets that are not part of an existing connection but are associated with an existing connection (Like ICMP responses to connection attempts)
  - INVALID: packets that are not associated with a connection or aren't appropriate for a new connection.
  - UNTRACKED: if marked with NOTRACK at the RAW table
  - SNAT: used to track packets associated with SNAT
  - DNAT: used to track packets associated with a DNAT
- MANGLE: alter packet headers
- NAT: performs network address translation
- FILTER: for basic filtering
- SECURITY: only used for systems that have SELinux installed



### Rules
As a packet goes through the chains, each rule in a chain will be used against the packet. If the packet matches the rule, then the target of the rule is applied.
Matching is defined by combinations of the following:
```
-4, --ipv4
-6, --ipv6
-p, --protocol PROTOCOL (tcp, udp, icmp, ...)
-s, --source [!]ADDRESS[/MASK]
-d, --destination [!]ADDRESS[/MASK]
-i, --in-interface [!]SRC_IF
-o, --out-interface [!]DST_IF
-sport, --source-port PORT[:PORT]
-dport, --destination-port PORT[:PORT]
-m, --match MATCH (used for special modules)
```

#### Targets
- Terminating targets perform an action which terminates evaluation within the chain and returns control to `netfilter`.
- Non-terminating targets perform an action but continues evaluation within the chain.

To set a target use:
```
-j, --jump TARGET
```
Target options:
- RETURN: will cause the current packet to stop traveling through the chain
- ACCEPT: will accept the current packet and will not continue traversing the current chain. It will still go through other chains.
- DNAT : only available in PREROUTING adn OUTPUT
- SNAT : only available in POSTROUTING
- DROP : drops the packet
- REJECT : drops but sends a reponse back (ICMP). Vali in INPUT, FORWARD and OUTPUT.
- LOG : adds to kernel log.
- ULOG : packet info is mulitcasted together with the whole packet through a netlink socket
- MARK : only valid in MANGLE.
- MASQUERADE : similar to SNAT but used on a outbound network interface when the outbound IP can change
- REDIRECT : redirects packets and streams to the machine itself. Valid in PREROUTING and OUTPUT chains

to work with rules:
```
- to append to the table:
iptables -A CHAIN MATCH -j TARGET [OPTIONS]
- to insert at the beginnning of the table:
iptables -I CHAIN MATCH -j TARGET [OPTIONS]
- to remove a rule:
iptables -D CHAIN MATCH -j TARGET [OPTIONS]
```

To list the contents of the table:
```
iptables -L [-v]
```

To list the contents of the table in iptable commands:
```
iptables -S
```


All iptables changes are ephemeral and they are lost on reload. To save them, use:
```
iptables -S
```
